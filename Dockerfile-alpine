FROM alpine:latest

ENV GCC_COLORS='error=01;31:warning=01;35:note=01;36:caret=01;32:locus=01:quote=01'
WORKDIR /workdir

RUN apk add \
    'argp-standalone' \
    'asciidoc' \
    'bash' \
    'bc' \
    'binutils' \
    'bzip2' \
    'cdrkit' \
    'coreutils' \
    'diffutils' \
    'elfutils-dev' \
    'findutils' \
    'flex' \
    'g++' \
    'gawk' \
    'gettext' \
    'git' \
    'grep' \
    'gzip' \
    'intltool' \
    'libxslt' \
    'linux-headers' \
    'musl-fts-dev' \
    'musl-libintl' \
    'musl-obstack-dev' \
    'ncurses-dev' \
    'openssl-dev' \
    'patch' \
    'perl' \
    'python3-dev' \
    'rsync' \
    'unzip' \
    'util-linux' \
    'zlib-dev' \
    'curl' 'build-base' 'wget' 'gnupg' 'tar' 'perl-utils' 'clang16' \
    'nano' 'expat' 'zsh' 'zsh-theme-powerlevel10k' 'cunit' 'autoconf' 'automake' 'libtool'

RUN curl -LO https://raw.githubusercontent.com/miyagawa/cpanminus/master/cpanm \
    && chmod +x cpanm \
    && ./cpanm App::cpanminus \
    && rm -fr ./cpanm /root/.cpanm

ENV PERL_CPANM_OPT --verbose --mirror https://cpan.metacpan.org --mirror-only
RUN cpanm Digest::SHA Module::Signature && rm -rf ~/.cpanm
ENV PERL_CPANM_OPT $PERL_CPANM_OPT --verify

RUN ln -s '/usr/lib/libncurses.so' '/usr/lib/libtinfo.so' && \
  addgroup 'buildbot' && \
  adduser -s '/bin/bash' -G 'buildbot' -D 'buildbot'

USER buildbot
RUN mkdir -p ~/.local/share/zsh/plugins && \
  ln -s /usr/share/zsh/plugins/powerlevel10k ~/.local/share/zsh/plugins/ && \
  echo "alias make='make -j$(nproc)' && alias cp='cp -i'" >> ~/.zshrc \
## These lines below are to automate the building of openssl, perl, nghttp3, ngtcp3, and libcurl.
## Only uncomment after first customizing your build using updating feeds, and using `make menuconfig` or `make nconfig`.
## Follow the guide here: https://openwrt.org/docs/guide-developer/toolchain/use-buildsystem
#  && cd openwrt && \ ## change this directory to whatever the root of the openwrt directory is called
#  make packages/libs/openssl/compile && \
#  mkdir -p staging_dir/hostpkg/usr/lib/perl5/5.38.2 && \
#  cp -r /usr/lib/perl5/core_perl/* staging_dir/hostpkg/usr/lib/perl5/5.38.2/ && \
#  PERL5LIB=/workdir/openwrt/staging_dir/hostpkg/usr/lib/perl5/5.38.2/ make packages/feeds/perl/compile && \
#  make packages/feeds/nghttp2/compile && make packages/feeds/nghttp3/compile && \
#  make packages/feeds/ngtcp2/compile && \
#  make packages/feeds/curl/compile
